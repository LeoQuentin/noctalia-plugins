#!/usr/bin/env bash
# gpu-switch-daemon â€” Non-interactive GPU mode switch for use with pkexec.
# Edits /etc/supergfxd.conf. Optionally reboots (runs as root so always works).
# Usage: gpu-switch-daemon <TargetMode> [reboot]

set -euo pipefail

CONF="/etc/supergfxd.conf"
TARGET="${1:?Usage: gpu-switch-daemon <TargetMode> [reboot]}"
CURRENT=$(supergfxctl -g)

if [[ "$CURRENT" == "$TARGET" ]]; then
    echo "Already in $TARGET mode"
    exit 0
fi

sed -i "s/\"mode\": \"$CURRENT\"/\"mode\": \"$TARGET\"/" "$CONF"

echo "$TARGET"

if [[ "${2:-}" == "reboot" ]]; then
    systemctl reboot
fi
